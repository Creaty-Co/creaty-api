services:
  db:
    container_name: test-db
    extends:
      file: ../docker-compose.base.yml
      service: db
    image: postgres:15.3-alpine
    env_file: [../../envs/.test.env]
    restart: 'no'

  redis-cache:
    container_name: test-redis-cache
    extends:
      file: ../docker-compose.base.yml
      service: redis-cache
    image: redis:7.0.12-alpine
    env_file: [../../envs/.test.env]
    restart: 'no'

  redis-cacheops:
    container_name: test-redis-cacheops
    extends:
      file: ../docker-compose.base.yml
      service: redis-cacheops
    image: redis:7.0.12-alpine
    env_file: [../../envs/.test.env]
    restart: 'no'

  redis-storage:
    container_name: test-redis-storage
    extends:
      file: ../docker-compose.base.yml
      service: redis-storage
    image: redis:7.0.12-alpine
    env_file: [../../envs/.test.env]
    restart: 'no'

  api:
    container_name: test-api
    extends:
      file: ../docker-compose.base.yml
      service: api
    image: python:3.12.4
    environment:
      PYTHONDONTWRITEBYTECODE: 1
      PYTHONUNBUFFERED: 1
      DJANGO_SETTINGS_MODULE: api.settings
    env_file: [../../envs/.test.env]
    working_dir: /api
    command: |
      sh -c "
        start_time=\$(date +%s)

        echo 'Running pip install -r requirements.txt...'
        pip install --no-cache-dir --disable-pip-version-check -r requirements.txt
        end_time=\$(date +%s)
        elapsed_time=\$((end_time - start_time))
        echo 'pip install -r requirements.txt took' \$elapsed_time 'seconds'

        start_time=\$(date +%s)

        echo 'Running coverage run manage.py test --noinput...'
        coverage run manage.py test --noinput
        end_time=\$(date +%s)
        elapsed_time=\$((end_time - start_time))
        echo 'coverage run manage.py test --noinput took' \$elapsed_time 'seconds'

        start_time=\$(date +%s)

        echo 'Running coverage report...'
        coverage report
        end_time=\$(date +%s)
        elapsed_time=\$((end_time - start_time))
        echo 'coverage report took' \$elapsed_time 'seconds'

        start_time=\$(date +%s)

        echo 'Running coverage xml -o /api/coverages/coverage.xml...'
        coverage xml -o /api/coverages/coverage.xml
        end_time=\$(date +%s)
        elapsed_time=\$((end_time - start_time))
        echo 'coverage xml -o /api/coverages/coverage.xml took' \$elapsed_time 'seconds'
      "
    volumes:
      - ../..:/api
    depends_on: [db, redis-cache, redis-cacheops, redis-storage]
    restart: 'no'

networks:
  db_network:
  redis_network:
