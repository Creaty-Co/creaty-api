name: "Call: deploy dev"

on:
  workflow_call:
    inputs:
      environment:
        type: string
        required: true
  workflow_dispatch:
    inputs:
      environment:
        type: string
        required: true

jobs:
  envs:
    uses: ./.github/workflows/call-envs.yml
    with:
      environment: ${{ inputs.environment }}
    environment:
      name: ${{ inputs.environment }}
    secrets: inherit
  deploy:
    runs-on: ubuntu-22.04
    needs: [ envs ]
    environment:
      name: ${{ inputs.environment }}
    steps:
      - name: Set .env file
        env:
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          EMAIL_URL: ${{ secrets.EMAIL_URL }}
          SENTRY_DSN: ${{ secrets.SENTRY_DSN }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          GOOGLE_APP_ID: ${{ secrets.GOOGLE_APP_ID }}
          GOOGLE_APP_SECRET: ${{ secrets.GOOGLE_APP_SECRET }}
          FIXER_ACCESS_KEY: ${{ secrets.FIXER_ACCESS_KEY }}
        run: |
          echo -e "${{ needs.envs.outputs.envs }}" > .env
          secrets=(
            "SECRET_KEY"
            "EMAIL_URL"
            "SENTRY_DSN"
            "POSTGRES_PASSWORD"
            "DATABASE_URL"
            "GOOGLE_APP_ID"
            "GOOGLE_APP_SECRET"
            "FIXER_ACCESS_KEY"
          )
          for secret in ${secrets[@]}; do
            value=$(echo "${!secret}")
            if [[ -z "$value" ]]; then
              echo "$secret is not defined"
              exit 1
            fi
            echo "$secret=$value" >> .env
          done
          cat .env
